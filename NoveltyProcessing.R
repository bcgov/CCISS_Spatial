dat <- structure(list(values = c(0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 
                          9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L, 21L, 
                          22L, 23L, 24L, 25L, 26L, 27L, 28L, 28L, 30L, 31L, 32L, 33L, 34L, 
                          35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L, 47L, 
                          48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 57L, 59L, 60L, 
                          61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L, 73L, 
                          74L, 75L, 76L, 77L, 78L, 79L, 80L, 81L, 82L, 83L, 84L, 85L, 86L, 
                          87L, 88L, 89L, 90L, 91L, 92L, 93L, 94L, 95L, 96L, 97L, 98L, 99L, 
                          100L, 101L, 102L, 103L, 104L, 105L, 106L, 107L, 108L, 109L, 110L, 
                          111L, 112L, 113L, 114L, 115L, 115L, 117L, 118L, 119L, 120L, 121L, 
                          122L, 123L, 124L, 125L, 126L, 127L, 128L, 129L, 130L, 131L, 132L, 
                          133L, 134L, 135L, 136L, 137L, 138L, 139L, 140L, 141L, 142L, 143L, 
                          144L, 145L, 146L, 147L, 148L, 149L, 150L, 151L, 152L, 153L, 154L, 
                          155L, 156L, 157L, 158L, 159L, 160L, 161L, 162L, 163L, 164L, 165L, 
                          166L, 167L, 168L, 169L, 170L, 171L, 172L, 173L, 174L, 175L, 176L, 
                          177L, 178L, 179L, 180L, 181L, 182L, 183L, 184L, 185L, 186L, 187L, 
                          188L, 189L, 190L, 191L, 192L, 193L, 194L, 195L, 196L, 197L, 198L, 
                          199L, 200L, 201L, 202L, 203L, 204L, 204L, 206L, 206L, 208L, 209L, 
                          210L, 211L, 212L, 213L, 214L, 215L, 216L, 217L, 218L, 219L, 220L, 
                          221L, 222L, 223L, 224L, 225L, 226L, 227L, 228L, 229L, 230L, 231L, 
                          231L, 233L, 234L, 235L, 236L, 237L, 238L, 239L, 240L, 241L, 242L, 
                          243L, 244L, 245L, 246L, 247L, 248L, 249L, 250L, 251L, 252L, 253L, 
                          254L, 255L, 256L, 257L, 258L, 259L, 260L, 261L, 262L, 263L, 264L, 
                          265L, 266L, 267L, 268L, 269L, 270L, 271L, 272L, 273L, 274L, 275L, 
                          276L, 277L, 278L, 279L, 280L, 281L, 282L, 283L, 284L, 285L, 286L, 
                          287L, 288L, 289L, 290L, 291L, 292L, 293L, 294L, 295L, 296L, 297L, 
                          298L, 299L, 300L, 301L, 302L, 303L, 304L, 305L, 306L, 307L, 308L, 
                          309L, 310L, 311L, 312L, 313L, 314L, 315L, 316L, 317L, 318L, 319L, 
                          320L, 321L, 322L, 323L, 324L, 325L, 326L, 327L, 328L, 329L, 330L, 
                          331L, 332L, 333L, 334L, 335L, 336L, 337L, 338L, 339L, 340L, 341L, 
                          342L, 343L, 344L, 345L, 346L, 347L, 348L, 349L, 350L, 351L, 352L, 
                          353L, 354L, 355L, 356L, 357L, 358L, 359L, 360L, 361L, 362L, 363L, 
                          364L, 365L, 366L, 367L, 368L, 369L, 370L, 371L, 372L, 373L, 374L, 
                          375L, 376L, 377L, 378L, 379L, 380L, 381L, 382L, 383L, 384L, 385L, 
                          386L, 387L, 388L, 389L, 390L, 391L, 392L, 393L, 394L, 395L, 396L, 
                          397L, 398L, 399L, 400L, 401L, 402L, 403L, 404L, 405L, 406L, 407L, 
                          408L, 409L, 409L, 411L, 412L, 413L, 413L, 415L, 416L, 417L, 418L, 
                          419L, 420L, 421L, 422L, 423L, 424L, 425L, 426L, 427L, 428L, 429L, 
                          430L, 431L, 432L, 433L, 434L, 435L, 436L, 437L, 438L, 438L, 440L, 
                          441L, 442L, 443L, 444L, 445L, 446L, 447L, 448L, 449L, 450L, 451L, 
                          452L, 453L, 454L, 455L, 456L, 457L, 458L, 459L, 460L, 461L, 462L, 
                          463L, 463L, 465L, 466L, 467L, 468L, 469L, 470L, 471L, 472L, 473L, 
                          474L, 475L, 476L, 477L, 478L, 479L, 480L, 481L, 482L, 483L, 484L, 
                          485L, 486L, 487L, 488L, 488L, 490L, 491L, 492L, 493L, 494L, 495L, 
                          496L, 497L, 498L, 499L, 500L, 501L, 502L, 503L, 504L, 505L, 506L, 
                          507L, 508L, 509L, 510L, 511L, 512L, 513L, 514L, 515L, 516L, 517L, 
                          518L, 519L, 520L, 521L, 522L, 523L, 524L, 525L, 526L, 527L, 528L, 
                          529L, 530L, 531L, 532L, 533L, 534L, 535L, 536L, 537L, 538L, 539L, 
                          540L, 541L, 542L, 543L, 544L, 545L, 546L, 547L, 548L, 549L, 550L, 
                          551L, 552L, 553L, 554L, 555L, 556L, 557L, 558L, 559L, 560L, 561L, 
                          562L, 563L, 564L, 565L, 566L, 567L, 568L, 569L, 570L, 571L, 572L, 
                          573L, 574L, 575L, 576L, 577L, 578L, 579L, 580L, 581L, 582L, 583L, 
                          584L, 585L, 586L, 587L, 588L, 589L, 590L, 591L, 592L, 593L, 594L, 
                          595L, 596L, 597L, 598L, 599L, 600L, 601L, 602L, 603L, 604L, 605L, 
                          606L, 607L, 608L, 609L, 610L, 611L, 612L, 613L, 614L, 615L, 616L, 
                          617L, 618L, 619L, 620L, 621L, 622L, 623L, 624L, 625L, 626L, 627L, 
                          628L, 629L, 630L, 631L, 632L, 633L, 634L, 635L, 636L, 637L, 638L, 
                          639L, 640L, 641L, 642L, 643L, 644L, 645L, 646L, 647L, 648L, 649L, 
                          650L, 651L, 652L, 653L, 654L, 655L, 656L, 657L, 658L, 659L, 660L, 
                          661L, 662L, 663L, 664L, 665L, 666L, 667L, 668L, 669L, 670L, 671L, 
                          672L, 673L, 674L, 675L, 676L, 677L, 678L, 679L, 680L, 681L, 682L, 
                          683L, 684L, 685L, 686L, 687L, 688L, 689L, 690L, 691L, 692L, 693L, 
                          694L, 695L, 696L, 697L, 698L, 699L, 700L, 701L, 702L, 703L, 704L, 
                          705L, 706L, 707L, 708L, 709L, 710L, 711L, 712L, 713L, 714L, 715L, 
                          716L, 717L, 718L, 719L, 720L, 721L, 722L, 723L, 724L, 725L, 726L, 
                          727L, 728L, 729L, 730L, 731L, 732L, 733L, 734L, 735L, 736L, 737L, 
                          738L, 739L, 740L, 741L, 742L, 743L, 744L, 745L, 746L, 747L, 748L, 
                          749L, 750L, 751L, 752L, 753L, 754L, 755L, 756L, 757L, 758L, 759L, 
                          760L, 761L, 762L, 763L, 764L, 765L, 766L, 767L, 768L, 769L, 770L, 
                          771L, 772L, 773L, 774L, 775L, 776L, 777L, 778L, 779L, 780L, 781L, 
                          782L, 783L, 784L, 785L, 786L, 787L, 788L, 789L, 790L, 791L, 792L, 
                          793L, 794L, 795L, 796L, 797L, 798L, 799L, 800L, 19900L, 810L, 
                          820L, 830L, 840L, 850L, 860L, 870L, 880L, 890L, 900L), color = c("#E5E5E5", 
                                                                                           "#E4E4E4", "#E3E3E3", "#E3E3E3", "#E2E2E2", "#E2E2E2", "#E1E1E1", 
                                                                                           "#E1E1E1", "#E0E0E0", "#E0E0E0", "#DFDFDF", "#DFDFDF", "#DEDEDE", 
                                                                                           "#DEDEDE", "#DDDDDD", "#DDDDDD", "#DCDCDC", "#DCDCDC", "#DBDBDB", 
                                                                                           "#DBDBDB", "#DADADA", "#DADADA", "#D9D9D9", "#D9D9D9", "#D8D8D8", 
                                                                                           "#D8D8D8", "#D7D7D7", "#D7D7D7", "#D6D6D6", "#D6D6D6", "#D5D5D5", 
                                                                                           "#D5D5D5", "#D4D4D4", "#D4D4D4", "#D3D3D3", "#D3D3D3", "#D2D2D2", 
                                                                                           "#D2D2D2", "#D1D1D1", "#D1D1D1", "#D0D0D0", "#D0D0D0", "#CFCFCF", 
                                                                                           "#CFCFCF", "#CECECE", "#CECECE", "#CDCDCD", "#CDCDCD", "#CCCCCC", 
                                                                                           "#CCCCCC", "#CBCBCB", "#CBCBCB", "#CACACA", "#CACACA", "#C9C9C9", 
                                                                                           "#C8C8C8", "#C8C8C8", "#C7C7C7", "#C7C7C7", "#C6C6C6", "#C6C6C6", 
                                                                                           "#C5C5C5", "#C5C5C5", "#C4C4C4", "#C4C4C4", "#C3C3C3", "#C3C3C3", 
                                                                                           "#C2C2C2", "#C2C2C2", "#C1C1C1", "#C1C1C1", "#C0C0C0", "#C0C0C0", 
                                                                                           "#BFBFBF", "#BFBFBF", "#BEBEBE", "#BEBEBE", "#BDBDBD", "#BDBDBD", 
                                                                                           "#BCBCBC", "#BCBCBC", "#BBBBBB", "#BBBBBB", "#BABABA", "#BABABA", 
                                                                                           "#B9B9B9", "#B9B9B9", "#B8B8B8", "#B8B8B8", "#B7B7B7", "#B7B7B7", 
                                                                                           "#B6B6B6", "#B6B6B6", "#B5B5B5", "#B5B5B5", "#B4B4B4", "#B4B4B4", 
                                                                                           "#B3B3B3", "#B3B3B3", "#B2B2B2", "#B2B2B2", "#B1B1B1", "#B1B1B1", 
                                                                                           "#B0B0B0", "#B0B0B0", "#AFAFAF", "#AFAFAF", "#AEAEAE", "#ADADAD", 
                                                                                           "#ADADAD", "#ACACAC", "#ACACAC", "#ABABAB", "#ABABAB", "#AAAAAA", 
                                                                                           "#AAAAAA", "#A9A9A9", "#A9A9A9", "#A8A8A8", "#A8A8A8", "#A7A7A7", 
                                                                                           "#A7A7A7", "#A6A6A6", "#A6A6A6", "#A5A5A5", "#A5A5A5", "#A4A4A4", 
                                                                                           "#A4A4A4", "#A3A3A3", "#A3A3A3", "#A2A2A2", "#A2A2A2", "#A1A1A1", 
                                                                                           "#A1A1A1", "#A0A0A0", "#A0A0A0", "#9F9F9F", "#9F9F9F", "#9E9E9E", 
                                                                                           "#9E9E9E", "#9D9D9D", "#9D9D9D", "#9C9C9C", "#9C9C9C", "#9B9B9B", 
                                                                                           "#9B9B9B", "#9A9A9A", "#9A9A9A", "#999999", "#999999", "#989898", 
                                                                                           "#989898", "#979797", "#979797", "#969696", "#969696", "#959595", 
                                                                                           "#959595", "#949494", "#949494", "#939393", "#929292", "#929292", 
                                                                                           "#919191", "#919191", "#909090", "#909090", "#8F8F8F", "#8F8F8F", 
                                                                                           "#8E8E8E", "#8E8E8E", "#8D8D8D", "#8D8D8D", "#8C8C8C", "#8C8C8C", 
                                                                                           "#8B8B8B", "#8B8B8B", "#8A8A8A", "#8A8A8A", "#898989", "#898989", 
                                                                                           "#888888", "#888888", "#878787", "#878787", "#868686", "#868686", 
                                                                                           "#858585", "#858585", "#848484", "#848484", "#838383", "#838383", 
                                                                                           "#828282", "#828282", "#818181", "#818181", "#808080", "#808080", 
                                                                                           "#7F7F7F", "#7F7F7F", "#7F7F7E", "#80807D", "#80807D", "#81817C", 
                                                                                           "#82817B", "#82827B", "#83827A", "#83837A", "#848479", "#858478", 
                                                                                           "#858578", "#868577", "#878676", "#878676", "#888775", "#898875", 
                                                                                           "#898874", "#8A8973", "#8A8973", "#8B8A72", "#8C8A71", "#8C8B71", 
                                                                                           "#8D8C70", "#8E8C6F", "#8E8D6F", "#8F8D6E", "#908E6E", "#908E6D", 
                                                                                           "#918F6C", "#92906C", "#92906B", "#93916A", "#93916A", "#949269", 
                                                                                           "#959268", "#959368", "#969467", "#979467", "#979566", "#989565", 
                                                                                           "#999665", "#999664", "#9A9763", "#9A9863", "#9B9862", "#9C9961", 
                                                                                           "#9C9961", "#9D9A60", "#9E9A60", "#9E9B5F", "#9F9C5E", "#A09C5E", 
                                                                                           "#A09D5D", "#A19D5C", "#A19E5C", "#A29F5B", "#A39F5B", "#A3A05A", 
                                                                                           "#A4A059", "#A5A159", "#A5A158", "#A6A257", "#A7A357", "#A7A356", 
                                                                                           "#A8A455", "#A9A455", "#A9A554", "#AAA554", "#AAA653", "#ABA752", 
                                                                                           "#ACA752", "#ACA851", "#ADA850", "#AEA950", "#AEA94F", "#AFAA4E", 
                                                                                           "#B0AB4E", "#B0AB4D", "#B1AC4D", "#B1AC4C", "#B2AD4B", "#B3AD4B", 
                                                                                           "#B3AE4A", "#B4AF49", "#B5AF49", "#B5B048", "#B6B047", "#B7B147", 
                                                                                           "#B7B146", "#B8B246", "#B9B345", "#B9B344", "#BAB444", "#BAB443", 
                                                                                           "#BBB542", "#BCB542", "#BCB641", "#BDB741", "#BEB740", "#BEB83F", 
                                                                                           "#BFB83F", "#C0B93E", "#C0BA3D", "#C1BA3D", "#C1BB3C", "#C2BB3B", 
                                                                                           "#C3BC3B", "#C3BC3A", "#C4BD3A", "#C5BE39", "#C5BE38", "#C6BF38", 
                                                                                           "#C7BF37", "#C7C036", "#C8C036", "#C8C135", "#C9C234", "#CAC234", 
                                                                                           "#CAC333", "#CBC333", "#CCC432", "#CCC431", "#CDC531", "#CEC630", 
                                                                                           "#CEC62F", "#CFC72F", "#D0C72E", "#D0C82D", "#D1C82D", "#D1C92C", 
                                                                                           "#D2CA2C", "#D3CA2B", "#D3CB2A", "#D4CB2A", "#D5CC29", "#D5CC28", 
                                                                                           "#D6CD28", "#D7CE27", "#D7CE27", "#D8CF26", "#D8CF25", "#D9D025", 
                                                                                           "#DAD024", "#DAD123", "#DBD223", "#DCD222", "#DCD321", "#DDD321", 
                                                                                           "#DED420", "#DED420", "#DFD51F", "#DFD61E", "#E0D61E", "#E1D71D", 
                                                                                           "#E1D71C", "#E2D81C", "#E3D91B", "#E3D91A", "#E4DA1A", "#E5DA19", 
                                                                                           "#E5DB19", "#E6DB18", "#E7DC17", "#E7DD17", "#E8DD16", "#E8DE15", 
                                                                                           "#E9DE15", "#EADF14", "#EADF13", "#EBE013", "#ECE112", "#ECE112", 
                                                                                           "#EDE211", "#EEE210", "#EEE310", "#EFE30F", "#EFE40E", "#F0E50E", 
                                                                                           "#F1E50D", "#F1E60D", "#F2E60C", "#F3E70B", "#F3E70B", "#F4E80A", 
                                                                                           "#F5E909", "#F5E909", "#F6EA08", "#F7EA07", "#F7EB07", "#F8EB06", 
                                                                                           "#F8EC06", "#F9ED05", "#FAED04", "#FAEE04", "#FBEE03", "#FCEF02", 
                                                                                           "#FCEF02", "#FDF001", "#FEF100", "#FEF100", "#FEF100", "#FEF000", 
                                                                                           "#FEEE00", "#FEED00", "#FDEC00", "#FDEB00", "#FDEA00", "#FDE800", 
                                                                                           "#FCE700", "#FCE600", "#FCE500", "#FCE400", "#FBE200", "#FBE100", 
                                                                                           "#FBE000", "#FBDF00", "#FADE00", "#FADC00", "#FADB00", "#FADA00", 
                                                                                           "#F9D900", "#F9D800", "#F9D600", "#F9D500", "#F8D400", "#F8D300", 
                                                                                           "#F8D100", "#F8D000", "#F7CF00", "#F7CE00", "#F7CD00", "#F7CB00", 
                                                                                           "#F6CA00", "#F6C900", "#F6C800", "#F6C700", "#F5C500", "#F5C400", 
                                                                                           "#F5C300", "#F5C200", "#F4C100", "#F4BF00", "#F4BE00", "#F4BD00", 
                                                                                           "#F3BC00", "#F3BB00", "#F3B900", "#F3B800", "#F2B700", "#F2B600", 
                                                                                           "#F2B400", "#F2B300", "#F1B200", "#F1B100", "#F1B000", "#F1AE00", 
                                                                                           "#F0AD00", "#F0AC00", "#F0AB00", "#F0AA00", "#EFA800", "#EFA700", 
                                                                                           "#EFA600", "#EFA500", "#EEA400", "#EEA200", "#EEA100", "#EEA000", 
                                                                                           "#ED9F00", "#ED9E00", "#ED9C00", "#ED9B00", "#EC9A00", "#EC9900", 
                                                                                           "#EC9700", "#EC9600", "#EB9500", "#EB9400", "#EB9300", "#EB9100", 
                                                                                           "#EA9000", "#EA8F00", "#EA8E00", "#EA8D00", "#E98B00", "#E98A00", 
                                                                                           "#E98900", "#E98800", "#E88700", "#E88500", "#E88400", "#E88300", 
                                                                                           "#E78200", "#E78100", "#E77F00", "#E77E00", "#E67D00", "#E67C00", 
                                                                                           "#E67A00", "#E67900", "#E57800", "#E57700", "#E57600", "#E57400", 
                                                                                           "#E47300", "#E47200", "#E47100", "#E47000", "#E36E00", "#E36D00", 
                                                                                           "#E36C00", "#E36B00", "#E26A00", "#E26800", "#E26700", "#E26600", 
                                                                                           "#E16500", "#E16400", "#E16200", "#E16100", "#E06000", "#E05F00", 
                                                                                           "#E05D00", "#E05C00", "#DF5B00", "#DF5A00", "#DF5900", "#DF5700", 
                                                                                           "#DE5600", "#DE5500", "#DE5400", "#DE5300", "#DD5100", "#DD5000", 
                                                                                           "#DD4F00", "#DD4E00", "#DC4D00", "#DC4B00", "#DC4A00", "#DC4900", 
                                                                                           "#DB4800", "#DB4600", "#DB4500", "#DB4400", "#DA4300", "#DA4200", 
                                                                                           "#DA4000", "#DA3F00", "#D93E00", "#D93D00", "#D93C00", "#D93A00", 
                                                                                           "#D83900", "#D83800", "#D83700", "#D83600", "#D73400", "#D73300", 
                                                                                           "#D73200", "#D73100", "#D63000", "#D62E00", "#D62D00", "#D62C00", 
                                                                                           "#D52B00", "#D52900", "#D52800", "#D52700", "#D42600", "#D42500", 
                                                                                           "#D42300", "#D42200", "#D32100", "#D32000", "#D31F00", "#D31D00", 
                                                                                           "#D21C00", "#D21B00", "#D21A00", "#D21900", "#D11700", "#D11600", 
                                                                                           "#D11500", "#D11400", "#D01300", "#D01100", "#D01000", "#D00F00", 
                                                                                           "#CF0E00", "#CF0C00", "#CF0B00", "#CF0A00", "#CE0900", "#CE0800", 
                                                                                           "#CE0600", "#CE0500", "#CD0400", "#CD0300", "#CD0200", "#CD0000", 
                                                                                           "#CC0000", "#CB0000", "#CA0000", "#C90000", "#C80000", "#C70000", 
                                                                                           "#C60000", "#C50000", "#C40000", "#C30000", "#C20000", "#C10000", 
                                                                                           "#C00000", "#BF0000", "#BE0000", "#BD0000", "#BC0000", "#BB0000", 
                                                                                           "#BA0000", "#B90000", "#B80000", "#B70000", "#B60000", "#B50000", 
                                                                                           "#B40000", "#B30000", "#B20000", "#B10000", "#B00000", "#AF0000", 
                                                                                           "#AE0000", "#AD0000", "#AB0000", "#AA0000", "#A90000", "#A80000", 
                                                                                           "#A70000", "#A60000", "#A50000", "#A40000", "#A30000", "#A20000", 
                                                                                           "#A10000", "#A00000", "#9F0000", "#9E0000", "#9D0000", "#9C0000", 
                                                                                           "#9B0000", "#9A0000", "#990000", "#980000", "#970000", "#960000", 
                                                                                           "#950000", "#940000", "#930000", "#920000", "#910000", "#900000", 
                                                                                           "#8F0000", "#8E0000", "#8D0000", "#8C0000", "#8B0000", "#8A0000", 
                                                                                           "#890000", "#880000", "#870000", "#860000", "#850000", "#840000", 
                                                                                           "#830000", "#820000", "#800000", "#7F0000", "#7E0000", "#7D0000", 
                                                                                           "#7C0000", "#7B0000", "#7A0000", "#790000", "#780000", "#770000", 
                                                                                           "#760000", "#750000", "#740000", "#730000", "#720000", "#710000", 
                                                                                           "#700000", "#6F0000", "#6E0000", "#6D0000", "#6C0000", "#6B0000", 
                                                                                           "#6A0000", "#690000", "#680000", "#670000", "#660000", "#650000", 
                                                                                           "#640000", "#630000", "#620000", "#610000", "#600000", "#5F0000", 
                                                                                           "#5E0000", "#5D0000", "#5C0000", "#5B0000", "#5A0000", "#590000", 
                                                                                           "#580000", "#570000", "#550000", "#540000", "#530000", "#520000", 
                                                                                           "#510000", "#500000", "#4F0000", "#4E0000", "#4D0000", "#4C0000", 
                                                                                           "#4B0000", "#4A0000", "#490000", "#480000", "#470000", "#460000", 
                                                                                           "#450000", "#440000", "#430000", "#420000", "#410000", "#400000", 
                                                                                           "#3F0000", "#3E0000", "#3D0000", "#3C0000", "#3B0000", "#3A0000", 
                                                                                           "#390000", "#380000", "#370000", "#360000", "#350000", "#340000", 
                                                                                           "#330000", "#320000", "#310000", "#300000", "#2F0000", "#2E0000", 
                                                                                           "#2D0000", "#2C0000", "#2A0000", "#290000", "#280000", "#270000", 
                                                                                           "#260000", "#250000", "#240000", "#230000", "#220000", "#210000", 
                                                                                           "#200000", "#1F0000", "#1E0000", "#1D0000", "#1C0000", "#1B0000", 
                                                                                           "#1A0000", "#190000", "#180000", "#170000", "#160000", "#150000", 
                                                                                           "#140000", "#130000", "#120000", "#110000", "#100000", "#0F0000", 
                                                                                           "#0E0000", "#0D0000", "#0C0000", "#0B0000", "#0A0000", "#090000", 
                                                                                           "#080000", "#070000", "#060000", "#050000", "#040000", "#030000", 
                                                                                           "#020000", "#010000", "#000000", "#000000", "#000000", "#000000", 
                                                                                           "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", 
                                                                                           "#000000")), row.names = c(NA, -812L), class = c("data.table", 
                                                                                                                                            "data.frame"))


##analog novelty database
library(climr)
library(terra)
library(data.table)
library(bcmaps)
library(ccissr)
library(ranger)
library(scales)
library(EnvStats)
library(plotly)

#---------------------------
# Data
#---------------------------

dat <- bcmaps::nr_districts()
dat <- st_transform(dat, 4326)
dat <- dat["ORG_UNIT"]

st_write(dat, "district_bnds.gpkg", append = FALSE)
d2 <- as.data.table(dat)

d2 <- st_read("FLP_Boundary.shp")

bbox_df <- d2 %>%
  rowwise() %>%
  mutate(bbox = list(st_bbox(geometry))) %>%
  mutate(
    xmin = bbox[["xmin"]],
    xmax = bbox[["xmax"]],
    ymin = bbox[["ymin"]],
    ymax = bbox[["ymax"]]
  ) %>%
  select(ORG_UNIT, xmin, xmax, ymin, ymax) %>%
  ungroup()
d3 <- st_drop_geometry(bbox_df)
fwrite(d3, "flp_bounds.csv")

d3 <- d2[,.(geometry = st_as_sfc(st_bbox(geometry))), by = ORG_UNIT]
d4
d3 <- st_as_sf(d3)
plot(d3[d3$ORG_UNIT == "DQU",])
st_write(d3, "district_bnds.gpkg")

#BGC model and variable list
load("../Common_Files/BGC_RFresp.Rdata") ##load RF model
pred_vars <- BGC_RFresp[["forest"]][["independent.variable.names"]] ##required predictors

# bc boundary
bc <- vect(bc_bound())
bc <- project(bc, "EPSG:4326")

# DEM
dir <- paste("//objectstore2.nrs.bcgov/ffec/Climatologies/PRISM_BC/PRISM_dem/", sep="")
dem <- rast(paste(dir, "PRISM_dem.asc", sep=""))
dem <- aggregate(dem, fact=4)
dem <- mask(dem, bc)
dem <- trim(dem)
plot(dem)
# climate data for the biogeoclimatic projections
gcms_use <- c("ACCESS-ESM1-5","EC-Earth3","GISS-E2-1-G","MIROC6","MPI-ESM1-2-HR","MRI-ESM2-0")
runs_use <- c("r1i1p1f1","r4i1p1f1","r2i1p3f1","r2i1p1f1","r1i1p1f1","r1i1p1f1")
ssp_use <- "ssp245"
periods_use <- list_gcm_periods()

grid <- as.data.frame(dem, cells = TRUE, xy = TRUE)
colnames(grid) <- c("id", "lon", "lat", "elev") # rename column names to what climr expects

res_ls <- list()
for(i in 1:length(gcms_use)){
  clim <- downscale(xyz = grid,
                         gcms = gcms_use[i],
                         ssps = ssp_use,
                         gcm_periods = list_gcm_periods(),
                         run_nm = runs_use[i],
                         vars = list_vars()
  )
  res_ls[[i]] <- clim
}

clim.grid <- rbindlist(res_ls)
addVars(clim.grid)
clim.grid <- clim.grid[is.finite(CMD.total)] #remove NA rows to have complete cases for RF model

#historical climate for training points
pts <- fread("//objectstore2.nrs.bcgov/ffec/BGC_models/WNA_v13_50-200filtpts_15Nov.csv")
colnames(pts) <- c("id", "BGC", "lon", "lat", "elev") # rename column names to what climr expects
clim.pts <- downscale(xyz = pts,
                      vars = list_vars())
addVars(clim.pts)

# Calculate the centroid climate for the training points
clim.pts.mean <- clim.pts[, lapply(.SD, mean), by = pts$BGC, .SDcols = -c(1,2)]

# historical interannual climatic variability at the geographic centroids of the training points
pts.mean <- pts[, lapply(.SD, mean), by = BGC]
pts.mean$id <- 1:dim(pts.mean)[1]
clim.icv.pts <- downscale(xyz = pts.mean,
                          obs_years = 1951:1990,
                          obs_ts_dataset = "cru.gpcc",
                          return_refperiod = FALSE,
                          vars = list_vars())
addVars(clim.icv.pts)
bgc.focal = "CWHxm_WA" # moderate to high novelty
bgc.pred <- predict(BGC_RFresp, data = clim.grid)[['predictions']]
clim.grid[,bgc_pred := bgc.pred]
vars <- c("id", "GCM", "SSP", "RUN", "PERIOD", "bgc_pred", as.vector(outer(c("Tmin", "Tmax", "PPT"), c("wt", "sp", "sm", "at"), paste, sep = "_")))
clim_final <- clim.grid[,..vars]
clim_final <- clim_final[!is.na(GCM),]
fwrite(clim_final,"Novelty_Predicted_Climate.csv")
readRenviron("./.Renviron")

library(RPostgres)
library(pool)
dbCon <- dbPool(
  drv = RPostgres::Postgres(),
  dbname = "cciss_spatial",
  host = Sys.getenv("BCGOV_HOST"),
  port = 5432, 
  user = Sys.getenv("BCGOV_USR"),
  password = Sys.getenv("BCGOV_PWD")
)
dbWriteTable(dbCon, "future_climate", clim_final, row.names = FALSE)
dbExecute(dbCon, "create index on future_climate(\"GCM\", \"PERIOD\", bgc_pred)")

test <- dbGetQuery(dbCon, "select * from future_climate where \"GCM\" = 'GISS-E2-1-G' and \"PERIOD\" = '2041_2060' and bgc_pred = 'CWHxm_WA'")

clim.pts[,bgc := pts$BGC]
vars <- c("id", "bgc", as.vector(outer(c("Tmin", "Tmax", "PPT"), c("wt", "sp", "sm", "at"), paste, sep = "_")))
hist.clim <- clim.pts[,..vars]
dbWriteTable(dbCon, "historic_climate", hist.clim, row.names = FALSE)
dbExecute(dbCon, "create index on historic_climate(bgc)")

clim_icv <- clim.icv.pts
clim_icv[,bgc := pts.mean$BGC[clim.icv.pts$id]]
vars <- c("id", "PERIOD", "bgc", as.vector(outer(c("Tmin", "Tmax", "PPT"), c("wt", "sp", "sm", "at"), paste, sep = "_")))
clim_icv <- clim_icv[,..vars]
dbWriteTable(dbCon, "historic_icv", clim_icv, row.names = FALSE)
dbExecute(dbCon, "create index on historic_icv(bgc)")


test_fut <- dbGetQuery(dbCon, "select * from future_climate where \"GCM\" = 'GISS-E2-1-G' and \"PERIOD\" = '2041_2060' and bgc_pred = 'CWHxm_WA'") |> as.data.table()
test_hist <- dbGetQuery(dbCon, "select * from historic_climate where bgc = 'CWHxm_WA'") |> as.data.table()
test_icv <- dbGetQuery(dbCon, "select * from historic_icv where bgc = 'CWHxm_WA'") |> as.data.table()

plot_analog_novelty(clim.target = test_fut, clim.analog = test_hist, clim.icv = test_icv)

zzz <- analog_novelty(clim.targets = clim_temp,
               clim.analogs = analog_temp,
               label.targets = bgc.pred[bgc.pred == bgc.focal],
               label.analogs = pts$BGC[pts$BGC == bgc.focal],
               vars = as.vector(outer(c("Tmin", "Tmax", "PPT"), c("wt", "sp", "sm", "at"), paste, sep = "_")),
               pcs = 3,
               analog.focal = bgc.focal,
               plotScree = FALSE,
               clim.icvs <- clim.icv.pts,
               label.icvs <- pts.mean$BGC[clim.icv.pts$id],
               plot3d = TRUE,
               plot3d.pcs=c(1,2,3)
)
